<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Jellron</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/styles.css">
    </head>

    <body>
        <main>
            <noscript>
                This page requires JavaScript. Please enable it, then refresh this page.
            </noscript>

            <p>
                You <em>must</em> place your camera at eye-level, far enough away for both of your shoulders to be
                visible, and in a well-lit area. If you do not, the models may not be able to detect you correctly
                and some of the calculations may be inaccurate.
            </p>

            <p>
                This demo only works in Chromium (i.e. Chrome & Edge) based browsers at the moment. It does not work
                in FireFox or Safari.
            </p>

            <p><b>To start the demo, select a video input device from the dropdown below.</b></p>

            <form>
                <fieldset id="webcam-settings">
                    <legend>Webcam</legend>

                    <fieldset>
                        <legend>Settings</legend>

                        <label>
                            Select a Video Input Device:
                            <div id="video-input-device-select-container"></div>
                        </label>
                        <label>
                            Body Detector Ready:
                            <span id="body-detector-ready">False</span>
                        </label>
                        <label>
                            Face Detector Ready:
                            <span id="face-detector-ready">False</span>
                        </label>
                        <label>
                            Hand Detector Ready:
                            <span id="hand-detector-ready">False</span>
                        </label>
                    </fieldset>

                    <fieldset id="webcam-stats">
                        <legend>Stats</legend>

                        <p>These stats are updated every 100ms, and show data for the last 30 samples.</p>

                        <p>If either average detection time is too high, the demo will stop running.</p>

                        <table>
                            <thead>
                            <tr>
                                <th>Label</th>
                                <th>Min</th>
                                <th>avg</th>
                                <th>Max</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>Body Detection Time</td>
                                <td id="body-detection-time-min"></td>
                                <td id="body-detection-time-avg"></td>
                                <td id="body-detection-time-max"></td>
                            </tr>
                            <tr>
                                <td>Face Mesh Detection Time</td>
                                <td id="face-mesh-detection-time-min"></td>
                                <td id="face-mesh-detection-time-avg"></td>
                                <td id="face-mesh-detection-time-max"></td>
                            </tr>
                            <tr>
                                <td>Hand Detection Time</td>
                                <td id="hand-detection-time-min"></td>
                                <td id="hand-detection-time-avg"></td>
                                <td id="hand-detection-time-max"></td>
                            </tr>
                            <tr>
                                <td>Mesh Draw Time</td>
                                <td id="mesh-draw-time-min"></td>
                                <td id="mesh-draw-time-avg"></td>
                                <td id="mesh-draw-time-max"></td>
                            </tr>
                            </tbody>
                        </table>
                    </fieldset>
                </fieldset>
            </form>

            <div id="jellron-display">
                <canvas></canvas>
                <video autoplay playsinline>
                    This page requires a browser that supports the <em>video</em> element.
                </video>
            </div>
        </main>
    </body>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core/dist/tf-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter/dist/tf-converter.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl/dist/tf-backend-webgl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection/dist/face-landmarks-detection.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection/dist/pose-detection.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection/dist/hand-pose-detection.min.js"></script>
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
          }
        }
    </script>

    <script type="module">
        import {Camera} from "./js/camera.js";
        import {BodyDetector} from "./js/detector/body_detector.js";
        import {FaceDetector} from "./js/detector/face_detector.js";
        import {HandDetector} from "./js/detector/hand_detector.js";
        import {Mesh} from "./js/mesh.js";
        import {MeshRenderer} from "./js/mesh_renderer.js";
        import {StatRecorder} from "./js/stat_recorder.js";
        import {WebGLRenderer} from "three";

        const canvas = document.getElementsByTagName("canvas")[0];
        const glContext = new WebGLRenderer({
            alpha: true,
            canvas: canvas
        });
        glContext.autoClear = true;

        const deviceSelect = await Camera.getSelectElement();
        document.getElementById("video-input-device-select-container").appendChild(deviceSelect);

        const mesh = new Mesh();
        const faceDetector = new FaceDetector();
        const bodyDetector = new BodyDetector();
        const handDetector = new HandDetector();
        const meshRenderer = new MeshRenderer();

        const faceDetectorStats = new StatRecorder(30);
        const bodyDetectorStats = new StatRecorder(30);
        const handDetectorStats = new StatRecorder(30);
        const meshRendererStats = new StatRecorder(30);

        setInterval(() => {
            if (!bodyDetector.isRunning() && !faceDetector.isRunning() && !handDetector.isRunning()) {
                return;
            }

            faceDetectorStats.record(faceDetector.getLastRuntime());
            bodyDetectorStats.record(bodyDetector.getLastRuntime());
            handDetectorStats.record(handDetector.getLastRuntime());
            meshRendererStats.record(meshRenderer.getLastRuntime());

            document.getElementById("body-detection-time-min").innerText = bodyDetectorStats.getMinimum().toFixed(2).toString();
            document.getElementById("body-detection-time-avg").innerText = bodyDetectorStats.getAverage().toFixed(2).toString();
            document.getElementById("body-detection-time-max").innerText = bodyDetectorStats.getMaximum().toFixed(2).toString();

            document.getElementById("face-mesh-detection-time-min").innerText = faceDetectorStats.getMinimum().toFixed(2).toString();
            document.getElementById("face-mesh-detection-time-avg").innerText = faceDetectorStats.getAverage().toFixed(2).toString();
            document.getElementById("face-mesh-detection-time-max").innerText = faceDetectorStats.getMaximum().toFixed(2).toString();

            document.getElementById("hand-detection-time-min").innerText = handDetectorStats.getMinimum().toFixed(2).toString();
            document.getElementById("hand-detection-time-avg").innerText = handDetectorStats.getAverage().toFixed(2).toString();
            document.getElementById("hand-detection-time-max").innerText = handDetectorStats.getMaximum().toFixed(2).toString();

            document.getElementById("mesh-draw-time-min").innerText = meshRendererStats.getMinimum().toFixed(2).toString();
            document.getElementById("mesh-draw-time-avg").innerText = meshRendererStats.getAverage().toFixed(2).toString();
            document.getElementById("mesh-draw-time-max").innerText = meshRendererStats.getMaximum().toFixed(2).toString();
        }, 100);

        const warmupInterval = setInterval(async () => {
            if (bodyDetector.isReady() && faceDetector.isReady() && handDetector.isReady()) {
                clearInterval(warmupInterval);

                document.getElementById("body-detector-ready").innerText = "True";
                document.getElementById("face-detector-ready").innerText = "True";
                document.getElementById("hand-detector-ready").innerText = "True";
                (await Camera.getSelectElement()).disabled = false;
            }
        }, 100);

        let resizeTimeout = null;
        const updateDisplay = async () => {
            clearTimeout(resizeTimeout);

            resizeTimeout = setTimeout(async () => {
                if (deviceSelect.value === "") {
                    return;
                }

                const camera = await new Camera(deviceSelect.value);
                await camera.setVideoElement(document.getElementsByTagName("video")[0]);

                const videoElement = await camera.getVideoElement();
                glContext.setSize(videoElement.width, videoElement.height, false);

                if (!bodyDetector.isRunning()) {
                    bodyDetector.start(15, videoElement, mesh);
                }

                if (!faceDetector.isRunning()) {
                    faceDetector.start(30, videoElement, mesh);
                }

                if (!handDetector.isRunning()) {
                    handDetector.start(10, videoElement, mesh);
                }

                /*
                 * If the render is already running and a resize occurs, there is an issue which causes all the points
                 * to be drawn in the wrong position. To fix this, we stop and then restart the renderer.
                 *
                 * todo Investigate this issue and determine if there's a better way to handle it.
                 */
                meshRenderer.display2DEarring(mesh, "./assets/earring.png", true);
                meshRenderer.display2DEarring(mesh, "./assets/earring.png", false);
                meshRenderer.display2DNecklace(mesh, "./assets/necklace.png");

                meshRenderer.stop();
                meshRenderer.start(60, glContext, mesh);
            }, 100);
        }

        window.onresize = () => updateDisplay();

        deviceSelect.onchange = () => {
            try {
                updateDisplay();
            } catch (error) {
                console.error(error);
            }
        };
    </script>
</html>
