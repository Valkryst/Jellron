<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Jellron</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">

        <link rel="stylesheet" href="css/styles.css">
    </head>

    <body>
        <main>
            <noscript>
                This page requires JavaScript. Please enable it, then refresh this page.
            </noscript>

            <p>You may need to refresh this page after altering camera permissions.</p>

            <form>
                <fieldset id="webcam-settings">
                    <legend>Webcam</legend>

                    <fieldset>
                        <legend>Settings</legend>

                        <label>
                            Select a Video Input Device:
                            <select name="video-input-devices" id="video-input-device-select"></select>
                        </label>
                    </fieldset>

                    <fieldset id="webcam-stats">
                        <legend>Stats</legend>

                        <label>
                            Face Mesh Detection Time (ms):
                            <span id="face-mesh-detection-time"></span>
                        </label>

                        <label>
                            Body Detection Time (ms):
                            <span id="body-detection-time"></span>
                        </label>

                        <label>
                            Mesh Draw Time (ms):
                            <span id="mesh-draw-time"></span>
                        </label>
                    </fieldset>
                </fieldset>

                <fieldset id="keypoint-settings">
                    <legend>Keypoints</legend>

                    <fieldset>
                        <legend>Face</legend>

                        <p>The face is displayed as a set of <em>green</em> squares.</p>

                        <label>
                            Show Face
                            <input type="checkbox" name="face" id="face-checkbox" checked>
                        </label>
                    </fieldset>

                    <fieldset>
                        <legend>Body</legend>

                        <p>The body is displayed as a set of <em>magenta</em> squares.</p>

                        <label>
                            Show Body
                            <input type="checkbox" name="body" id="body-checkbox" checked>
                        </label>
                    </fieldset>

                    <fieldset>
                        <legend>Necklace</legend>

                        <p>The necklace is displayed as a <em>red</em> square.</p>

                        <label>
                            Show Necklace
                            <input type="checkbox" name="necklace" id="necklace-checkbox" checked>
                        </label>

                        <label>
                            xOffset:
                            <input type="number" name="necklace-x-offset" id="necklace-x-offset-input" value="0" step="1">
                        </label>

                        <label>
                            yOffset:
                            <input type="number" name="necklace-y-offset" id="necklace-y-offset-input" value="0" step="1">
                        </label>

                        <label>
                            zOffset:
                            <input type="number" name="necklace-z-offset" id="necklace-z-offset-input" value="0" step="1">
                        </label>
                    </fieldset>

                    <fieldset>
                        <legend>Choker</legend>

                        <p>The choker is displayed as a <em>blue</em> square.</p>

                        <p>
                            The choker's position is relative to the necklace's position. Any changes to the necklace's
                            position will also affect the choker's position.
                        </p>

                        <label>
                            Show Choker
                            <input type="checkbox" name="choker" id="choker-checkbox" checked>
                        </label>

                        <label>
                            xOffset:
                            <input type="number" name="choker-x-offset" id="choker-x-offset-input" value="0" step="1">
                        </label>

                        <label>
                            yOffset:
                            <input type="number" name="choker-y-offset" id="choker-y-offset-input" value="0" step="1">
                        </label>

                        <label>
                            zOffset:
                            <input type="number" name="choker-z-offset" id="choker-z-offset-input" value="0" step="1">
                        </label>
                    </fieldset>
                </fieldset>
            </form>

            <video autoplay playsinline>
                This page requires a browser that supports the <em>video</em> element.
            </video>

            <canvas></canvas>
        </main>
    </body>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
    <script type="module">
        import { displayVideoInput, getVideoInputDevice, populateVideoInputSelect, promptForPermissions } from "./js/device.js";
        import {BodyDetector} from "./js/body_detector.js";
        import {FaceDetector} from "./js/face_detector.js";
        import {Mesh} from "./js/mesh.js";
        import {MeshRenderer} from "./js/mesh_renderer.js";

        function getNumericInputValue(elementId) {
            const inputElement = document.getElementById(elementId);
            if (inputElement === null) {
                throw new Error(`Could not locate element using the ID "${elementId}".`);
            }

            return parseInt(inputElement.value);
        }

        promptForPermissions();

        const canvas = document.getElementsByTagName("canvas")[0];
        const canvasContext = canvas.getContext("2d");

        const mesh = new Mesh();
        const faceDetector = new FaceDetector();
        const bodyDetector = new BodyDetector();
        const meshRenderer = new MeshRenderer();

        setInterval(() => {
            document.getElementById("face-mesh-detection-time").innerText = (faceDetector.getLastRuntime()).toString();
            document.getElementById("body-detection-time").innerText = (bodyDetector.getLastRuntime()).toString();
            document.getElementById("mesh-draw-time").innerText = (meshRenderer.getLastRuntime()).toString();
        }, 250);

        const videoElement = document.getElementsByTagName("video")[0];
        const deviceSelect = document.getElementById("video-input-device-select");
        deviceSelect.onchange = async () => {
            try {
                await displayVideoInput(videoElement, deviceSelect.value);

                const device = await getVideoInputDevice(deviceSelect.value);
                const deviceCapabilities = device.getVideoTracks()[0].getCapabilities()

                videoElement.width = deviceCapabilities.width.max;
                videoElement.height = deviceCapabilities.height.max;
                canvas.width = deviceCapabilities.width.max;
                canvas.height = deviceCapabilities.height.max;

                await faceDetector.start(30, videoElement, mesh);
                await bodyDetector.start(30, videoElement, mesh);
                meshRenderer.start(60, canvasContext, mesh);
            } catch (error) {
                console.error(error);

                faceDetector.stop();
                bodyDetector.stop();
                meshRenderer.stop();
            }
        };

        populateVideoInputSelect(deviceSelect);
        navigator.mediaDevices.ondevicechange = () => {
            // todo Test whether the active device stays selected and that the dropdown updates its  options.
            populateVideoInputSelect(deviceSelect);
        };


        // Register Listeners for Face Settings
        let element = document.getElementById("face-checkbox");
        element.addEventListener("change", () => {
            const element = document.getElementById("face-checkbox");
            meshRenderer.setDisplayFace(element.checked);
        });



        // Register Listeners for Body Settings
        element = document.getElementById("body-checkbox");
        element.addEventListener("change", () => {
            const element = document.getElementById("body-checkbox");
            meshRenderer.setDisplayBody(element.checked);
        });



        // Register Listeners for Choker Settings
        element = document.getElementById("choker-checkbox");
        element.addEventListener("change", () => {
            const element = document.getElementById("choker-checkbox");
            meshRenderer.setDisplayChoker(element.checked);
        });

        function updateChokerOffsets() {
            const xOffset = getNumericInputValue("choker-x-offset-input");
            const yOffset = getNumericInputValue("choker-y-offset-input");
            const zOffset = getNumericInputValue("choker-z-offset-input");
            mesh.setChokerOffsets(xOffset, yOffset, zOffset);
        }

        element = document.getElementById("choker-x-offset-input");
        element.addEventListener("change", () => updateChokerOffsets());

        element = document.getElementById("choker-y-offset-input");
        element.addEventListener("change", () => updateChokerOffsets());

        element = document.getElementById("choker-z-offset-input");
        element.addEventListener("change", () => updateChokerOffsets());



        // Register Listeners for Necklace Settings
        element = document.getElementById("necklace-checkbox");
        element.addEventListener("change", () => {
            const element = document.getElementById("necklace-checkbox");
            meshRenderer.setDisplayNecklace(element.checked);
        });

        function updateNecklaceOffsets() {
            const xOffset = getNumericInputValue("necklace-x-offset-input");
            const yOffset = getNumericInputValue("necklace-y-offset-input");
            const zOffset = getNumericInputValue("necklace-z-offset-input");
            mesh.setNecklaceOffsets(xOffset, yOffset, zOffset);
        }

        element = document.getElementById("necklace-x-offset-input");
        element.addEventListener("change", () => updateNecklaceOffsets());

        element = document.getElementById("necklace-y-offset-input");
        element.addEventListener("change", () => updateNecklaceOffsets());

        element = document.getElementById("necklace-z-offset-input");
        element.addEventListener("change", () => updateNecklaceOffsets());

    </script>
</html>